<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Page</title>
    <link rel="stylesheet" href="/bootstrap-5.2.0-beta1-dist/css/bootstrap.css">
</head>
<body>
    <div class="container">
        <div class="row">
            <!-- <a href="#" class="text-muted float-end" id="signOut"> -->
                <div class="col-6 mx-auto shadow p-5">
                    <input type="text" placeholder="Product name" class="form-control mt-2" id="todoInp">
                    <input type="text" placeholder="Price" class="form-control mt-2" id="todoInp2">
                    <input type="text" placeholder="Discount" class="form-control mt-2" id="todoInp3">
                    <input type="file" class="form-control mt-2" id="fileInp">
                    <input type="number" placeholder="Quantity Available" class="form-control mt-2" id="quantity">
                    
                    <button class="btn btn-dark w-100 mt-4" id="todoBtn">Add</button>
                    <button id="signOut" class="btn btn-secondary mt-2">Log Out</button>

                <div id="loader" class="bg-warning display-6 text-center"></div>              
            </div>
            <div id="allTodo" class="row container"></div>
        </div>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.9.0/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/9.9.0/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.9.0/firebase-auth.js";
        import { getStorage, uploadBytes, ref as stRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.9.0/firebase-storage.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries
        
        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyBLkEJmc0ptxW5G4mHXAZrU6fpuqMKJY1M",
            authDomain: "level-2-project-66a2d.firebaseapp.com",
            projectId: "level-2-project-66a2d",
            storageBucket: "level-2-project-66a2d.appspot.com",
            messagingSenderId: "505285968745",
            appId: "1:505285968745:web:58b84688dc923c892533f8"
        };
    
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase();
        const auth = getAuth();
        const storage = getStorage();

        let userDetails = {}
        onAuthStateChanged(auth, (user) =>{
            if (user) {
                userDetails.email = user.email;
                userDetails.uid = user.uid;
            } else {
                window.location = "signUp.html";
            }
        })

        let dbRef = ref(db, "todos");
        let todoArray = [];
        let todoId = 0;
        onValue(dbRef, function(snapshot){
            todoArray = snapshot.val();
            if (todoArray) {
                todoId = todoArray.length;
                displayTodo(todoArray);
            } else {
                todoId = 0;         
            }
        })
    

        

        document.getElementById("todoBtn").addEventListener("click", function(){
            let todo = {pname:todoInp.value,price:todoInp2.value,Discount:todoInp3.value, Q_Available: quantity.value}
            let files = fileInp.files[0];
            let fileName = files.name;
            let date = new Date();

            let todoObj = {email: userDetails.email, img_name: fileName, todo, time: date.toLocaleTimeString()};
            let todoRef = ref(db, `todos/${todoId}`);
            set(todoRef, todoObj);

            let imgRef = stRef(storage, `images/${fileName}`);
            let uploadImage = uploadBytesResumable(imgRef, files);
            uploadImage.on("state-changed", function(snapshot){
                let totalBytes = snapshot.totalBytes;
                let bytesTransferred = snapshot.bytesTransferred;
                let progress = Math.round((bytesTransferred/totalBytes) * 100);

                loader.innerHTML = `<div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: ${progress}%"><span style="font-size: 20px;float:right;" class="px-2">${progress}%</span></div>
                </div>`;
            }, function (error) {
                loader.innerHTML = `${error}%`
            }, function () {
                loader.innerHTML = "Uploaded!";
                loader.style.background = "green";
                loader.style.color = "white";
            })
            
            todoInp.value = "";
            todoInp2.value = "";
            todoInp3.value = "";
            fileInp.value = "";
            quantity.value = "";
        })

        function displayTodo (todoArray) {
            let userTodo = todoArray.filter((each)=> each.email == userDetails.email);
            userTodo.map((todo, i) => {
                let imgRef = stRef(storage, `images/${todo.img_name}`);
                getDownloadURL(imgRef).then((url) => {
                    allTodo.innerHTML += `<div class="col-sm-12 col-lg-2 col-md-5 card shadow mx-md-3 mt-4 mb-3 p-2">
                        <img src="${url}" style="height: 70%; object-fit: cover; border-radius:6px 6px 0 0;">
                        <span style="font-size: 20px;" class="px-2">${todo.todo.pname}</span>
                        <span style="font-size: 20px;" class="px-2">$ ${todo.todo.price}</span>
                        <span style="font-size: 20px;" class="px-2">Discount: -${todo.todo.Discount}%</span>
                        <span style="font-size: 20px;" class="px-2"><i class="text-muted" style="font-size: 10px;">${todo.time}</i></span>
                        <button class="btn btn-dark my-2" style="border-radius:0 0 px 6px;" id="${i}">Delete</button>
                    </div>`
                })
            })
        }

        document.getElementById("signOut").addEventListener("click", function() {
            signOut(auth).then((response) => {
                window.location = "signIn.html";
            }).catch((error) => {
                console.log(response);
            })
        })
      
    </script>
    <script src="/bootstrap-5.2.0-beta1-dist/js/bootstrap.js"></script>
</body>
</html>